<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Import Checker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .card {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .scanner-overlay {
            position: relative;
            overflow: hidden;
        }
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #10b981, transparent);
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-shipping-fast text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Smart Import Checker</h1>
                        <p class="text-xs text-gray-500">Pro Version</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-900" id="currentRoundDisplay">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö</p>
                        <p class="text-xs text-gray-500" id="roundStats">0 ‡∏û‡∏±‡∏™‡∏î‡∏∏</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="relative">
                            <input type="text" id="sheetSelector" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î..." 
                                   class="px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-sm w-64">
                            <button id="loadSheetHeaderBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-700 transition-colors" title="‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <button id="refreshSheetsBtn" class="text-gray-600 hover:text-blue-500 transition-colors" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏µ‡∏ó">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <button id="roundsBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-layer-group mr-1"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ö
                    </button>
                    <button id="summaryBtn" class="text-gray-600 hover:text-blue-500 transition-colors" title="‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ">
                        <i class="fas fa-chart-bar text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- Sheet Status Alert -->
        <div id="sheetAlert" class="mb-6 bg-blue-50 border border-blue-200 rounded-xl p-4 fade-in">
            <div class="flex items-center">
                <i class="fas fa-table text-blue-500 mr-3"></i>
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-blue-800">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets</h3>
                    <p class="text-sm text-blue-700 mt-1" id="sheetStatusText">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span id="sheetStatusBadge" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
                </div>
            </div>
        </div>

        <!-- Round Selection Alert -->
        <div id="roundAlert" class="mb-6 bg-yellow-50 border border-yellow-200 rounded-xl p-4 fade-in">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-yellow-800">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                    <p class="text-sm text-yellow-700 mt-1">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</p>
                </div>
                <button id="createFirstRoundBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å
                </button>
            </div>
        </div>

        <!-- Package Entry Section -->
        <div id="packageSection" class="hidden space-y-6">
            <!-- Package Info Card -->
            <div class="bg-white rounded-xl p-6 card">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡∏°‡πà</h2>
                
                <!-- Package Number and Import Cost Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Package Number -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏/‡πÅ‡∏ó‡∏£‡∏Å‡∏Å‡∏¥‡πâ‡∏á</label>
                        <input type="text" id="packageNumber" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏..." 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>

                    <!-- Import Cost -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</label>
                        <input type="number" id="shippingCost" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó)" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>
                </div>


            </div>

            <!-- Products Card -->
            <div class="bg-white rounded-xl p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏</h3>
                    <button id="addProductBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    </button>
                </div>
                <div id="productList" class="space-y-4">
                    <div id="noProductsMessage" class="text-center py-8 text-gray-500">
                        <i class="fas fa-plus-circle text-4xl mb-3 text-gray-300"></i>
                        <p class="text-lg font-medium mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏</p>
                        <p class="text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                    </div>
                </div>
            </div>

            <!-- Cost Distribution Card -->
            <div class="bg-white rounded-xl p-6 card">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h3>
                <div class="flex items-center justify-between mb-4">
                    <select id="costDistributionMethod" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                        <option value="proportion">‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</option>
                        <option value="equal">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÜ ‡∏Å‡∏±‡∏ô</option>
                        <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                    </select>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="totalDistributed" class="font-medium text-blue-600">0</span> ‡∏ö‡∏≤‡∏ó</p>
                        <p class="text-sm text-gray-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="remainingCost" class="font-medium">0</span> ‡∏ö‡∏≤‡∏ó</p>
                    </div>
                </div>
                <div id="shippingDistribution" class="space-y-3">
                    <!-- Distribution will be shown here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-4">
                <button id="testSaveBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg transition-colors text-sm">
                    <i class="fas fa-bug mr-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                </button>
                <button id="clearFormBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition-colors">
                    <i class="fas fa-eraser mr-2"></i>‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                </button>
                <button id="savePackageBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏
                </button>
            </div>
        </div>

        <!-- Rounds Management Modal -->
        <div id="roundsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-96 overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <button id="closeRoundsModal" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Create New Round -->
                <div class="mb-6 p-4 bg-blue-50 rounded-xl">
                    <h3 class="font-medium text-gray-900 mb-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
                    <div class="flex space-x-3">
                        <input type="text" id="newRoundName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2024" 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                        <button id="createRoundBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-1"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á
                        </button>
                    </div>
                </div>

                <!-- Existing Rounds -->
                <div>
                    <h3 class="font-medium text-gray-900 mb-3">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</h3>
                    <div id="roundsList" class="space-y-2">
                        <!-- Rounds will be listed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div id="summarySection" class="hidden space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-900">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</h2>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" id="summarySheetInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î..." 
                               class="px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors w-64">
                        <button id="loadSheetBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-700 transition-colors">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <select id="summaryRoundSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                    </select>
                    <button id="backToMainBtn" class="text-gray-600 hover:text-blue-500 transition-colors">
                        <i class="fas fa-arrow-left mr-1"></i>‡∏Å‡∏•‡∏±‡∏ö
                    </button>
                </div>
            </div>



            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-xl p-6 card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-box text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalPackages">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-check text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö</p>
                            <p class="text-2xl font-bold text-gray-900" id="completeItems">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-exclamation text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏î</p>
                            <p class="text-2xl font-bold text-gray-900" id="missingItems">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ß‡∏°</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalCost">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Missing Products Analysis -->
            <div class="bg-white rounded-xl p-6 card mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î</h3>
                    <div class="flex items-center space-x-4">
                        <button id="analyzeMissingBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-calculator mr-1"></i>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
                        </button>
                        <button id="copyMissingBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors hidden">
                            <i class="fas fa-copy mr-1"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
                        </button>
                    </div>
                </div>
                
                <!-- Missing Products Alert -->
                <div id="missingProductsAlert" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-3 mt-1"></i>
                        <div class="flex-1">
                            <h4 class="font-medium text-red-800 mb-2">‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î</h4>
                            <p class="text-sm text-red-700 mb-3" id="missingProductsSummary"></p>
                            <div class="flex items-center space-x-3">
                                <button id="showMissingDetailsBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                    <i class="fas fa-list mr-1"></i>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                </button>
                                <button id="copyMissingListBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                    <i class="fas fa-copy mr-1"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Missing Products Cards -->
                <div id="missingProductsTable" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-medium text-gray-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥</h4>
                        <div class="flex items-center space-x-3">
                            <select id="missingProductsFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-sm">
                                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="missing">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î</option>
                                <option value="complete">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö</option>
                                <option value="partial">‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô</option>
                            </select>
                            <span id="missingProductsCount" class="text-sm text-gray-600">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                    </div>
                    <div id="missingProductsCards" class="space-y-4">
                        <!-- Missing products cards will be populated here -->
                    </div>
                </div>

                <!-- No Missing Products Message -->
                <div id="noMissingProductsMessage" class="hidden text-center py-8 text-green-600">
                    <i class="fas fa-check-circle text-4xl mb-3"></i>
                    <p class="text-lg font-medium mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î</p>
                    <p class="text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                </div>

                <!-- Analysis Instructions -->
                <div id="analysisInstructions" class="text-center py-8 text-gray-500">
                    <i class="fas fa-calculator text-4xl mb-3 text-gray-300"></i>
                    <p class="text-lg font-medium mb-2">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î</p>
                    <p class="text-sm mb-4">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</p>
                    <p class="text-xs text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏´‡∏±‡∏Å‡∏•‡∏ö‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</p>
                </div>
            </div>

            <!-- Summary Table -->
            <div class="bg-white rounded-xl p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div class="flex items-center space-x-4">
                        <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="complete">‡∏Ñ‡∏£‡∏ö</option>
                            <option value="missing">‡∏Ç‡∏≤‡∏î</option>
                            <option value="excess">‡πÄ‡∏Å‡∏¥‡∏ô</option>
                        </select>
                        <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-download mr-1"></i>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
                        </button>
                        <button id="copySummaryBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-copy mr-1"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ
                        </button>
                        <button id="saveToSheetsBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-cloud-upload mr-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Sheets
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-300 bg-gray-50">
                                <th colspan="3" class="text-left py-4 px-4 font-bold text-gray-800 text-lg border-r border-gray-300">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th colspan="1" class="text-center py-4 px-4 font-bold text-gray-800 text-lg border-r border-gray-300">‡∏û‡∏±‡∏™‡∏î‡∏∏</th>
                                <th colspan="3" class="text-center py-4 px-4 font-bold text-gray-800 text-lg border-r border-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th colspan="1" class="text-center py-4 px-4 font-bold text-gray-800 text-lg border-r border-gray-300">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
                                <th colspan="2" class="text-center py-4 px-4 font-bold text-gray-800 text-lg">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                            <tr class="border-b border-gray-200 bg-gray-25">
                                <th class="text-left py-3 px-4 font-medium text-gray-700 border-r border-gray-200">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700 border-r border-gray-200">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700 border-r border-gray-200">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700 border-r border-gray-200">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</th>
                                <th class="text-center py-3 px-4 font-medium text-gray-700 border-r border-gray-200">‡∏™‡∏±‡πà‡∏á<br><span class="text-xs text-gray-500">(‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</span></th>
                                <th class="text-center py-3 px-4 font-medium text-gray-700 border-r border-gray-200">‡πÑ‡∏î‡πâ</th>
                                <th class="text-center py-3 px-4 font-medium text-gray-700 border-r border-gray-200">‡∏ï‡πà‡∏≤‡∏á</th>
                                <th class="text-center py-3 px-4 font-medium text-gray-700 border-r border-gray-200">‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤<br><span class="text-xs text-gray-500">(‡∏ö‡∏≤‡∏ó)</span></th>
                                <th class="text-center py-3 px-4 font-medium text-gray-700 border-r border-gray-200">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="text-center py-3 px-4 font-medium text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                            <!-- Summary data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            SHEETS_URL: 'https://docs.google.com/spreadsheets/d/1kD1uXM3kRJzgQ2SP7gFRsLGWfjrKTdfG_t-4DNuCBok/edit?gid=502811608#gid=502811608',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwW773eZ2hU1JT0F7nCDbleMBLIWwPiSt4RnQDEzs2TuVwAUNrTkwAchZcZcTN4ujpE/exec',
            SHEET_ID: '1kD1uXM3kRJzgQ2SP7gFRsLGWfjrKTdfG_t-4DNuCBok',
            SUMMARY_SHEET_NAME: '‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤',
            DEFAULT_SHEET_NAME: 'Sheet1'
        };

        // Global State
        let currentRound = null;
        let allRoundsData = {};
        let sheetsData = [];
        let currentPackageProducts = [];
        let availableSheets = [];
        let currentSheetName = null;
        let summarySheetData = []; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏µ‡∏ó‡∏™‡∏£‡∏∏‡∏õ
        let missingProductsData = []; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î

        // DOM Elements
        const elements = {
            // Main sections
            sheetAlert: document.getElementById('sheetAlert'),
            roundAlert: document.getElementById('roundAlert'),
            packageSection: document.getElementById('packageSection'),
            summarySection: document.getElementById('summarySection'),
            
            // Header
            currentRoundDisplay: document.getElementById('currentRoundDisplay'),
            roundStats: document.getElementById('roundStats'),
            roundsBtn: document.getElementById('roundsBtn'),
            summaryBtn: document.getElementById('summaryBtn'),
            sheetSelector: document.getElementById('sheetSelector'),
            loadSheetHeaderBtn: document.getElementById('loadSheetHeaderBtn'),
            refreshSheetsBtn: document.getElementById('refreshSheetsBtn'),
            sheetStatusText: document.getElementById('sheetStatusText'),
            sheetStatusBadge: document.getElementById('sheetStatusBadge'),
            
            // Package form
            packageNumber: document.getElementById('packageNumber'),
            shippingCost: document.getElementById('shippingCost'),
            productList: document.getElementById('productList'),
            addProductBtn: document.getElementById('addProductBtn'),
            savePackageBtn: document.getElementById('savePackageBtn'),
            clearFormBtn: document.getElementById('clearFormBtn'),
            
            // Cost distribution
            costDistributionMethod: document.getElementById('costDistributionMethod'),
            shippingDistribution: document.getElementById('shippingDistribution'),
            totalDistributed: document.getElementById('totalDistributed'),
            remainingCost: document.getElementById('remainingCost'),
            
            // Rounds modal
            roundsModal: document.getElementById('roundsModal'),
            closeRoundsModal: document.getElementById('closeRoundsModal'),
            newRoundName: document.getElementById('newRoundName'),
            createRoundBtn: document.getElementById('createRoundBtn'),
            roundsList: document.getElementById('roundsList'),
            createFirstRoundBtn: document.getElementById('createFirstRoundBtn'),
            
            // Summary
            summarySheetInput: document.getElementById('summarySheetInput'),
            loadSheetBtn: document.getElementById('loadSheetBtn'),
            summaryRoundSelect: document.getElementById('summaryRoundSelect'),
            backToMainBtn: document.getElementById('backToMainBtn'),
            statusFilter: document.getElementById('statusFilter'),
            exportBtn: document.getElementById('exportBtn'),
            copySummaryBtn: document.getElementById('copySummaryBtn'),
            saveToSheetsBtn: document.getElementById('saveToSheetsBtn'),

            summaryTableBody: document.getElementById('summaryTableBody'),
            totalPackages: document.getElementById('totalPackages'),
            completeItems: document.getElementById('completeItems'),
            missingItems: document.getElementById('missingItems'),
            totalCost: document.getElementById('totalCost'),

            // Missing Products Analysis
            analyzeMissingBtn: document.getElementById('analyzeMissingBtn'),
            copyMissingBtn: document.getElementById('copyMissingBtn'),
            missingProductsAlert: document.getElementById('missingProductsAlert'),
            missingProductsSummary: document.getElementById('missingProductsSummary'),
            showMissingDetailsBtn: document.getElementById('showMissingDetailsBtn'),
            copyMissingListBtn: document.getElementById('copyMissingListBtn'),
            missingProductsTable: document.getElementById('missingProductsTable'),
            missingProductsTableBody: document.getElementById('missingProductsTableBody'),
            noMissingProductsMessage: document.getElementById('noMissingProductsMessage'),
            analysisInstructions: document.getElementById('analysisInstructions')
        };

        // Initialize App
        function initApp() {
            console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...');
            loadSavedData();
            setupEventListeners();
            loadAvailableSheets();
            updateUI();
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á
            addProductItem();
            
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            console.log('üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            const saveBtn = document.getElementById('savePackageBtn');
            if (saveBtn) {
                console.log('‚úÖ ‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:', saveBtn);
                console.log('üìã Event listeners:', getEventListeners ? getEventListeners(saveBtn) : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ');
            } else {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!');
            }
        }

        // Load saved data from localStorage
        function loadSavedData() {
            const savedRounds = localStorage.getItem('allRoundsData');
            if (savedRounds) {
                try {
                    allRoundsData = JSON.parse(savedRounds);
                } catch (error) {
                    console.error('Error loading saved rounds:', error);
                    allRoundsData = {};
                }
            }

            const savedCurrentRound = localStorage.getItem('currentRound');
            if (savedCurrentRound && allRoundsData[savedCurrentRound]) {
                currentRound = savedCurrentRound;
            }

            const savedSheetName = localStorage.getItem('currentSheetName');
            if (savedSheetName) {
                currentSheetName = savedSheetName;
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('allRoundsData', JSON.stringify(allRoundsData));
            localStorage.setItem('currentRound', currentRound || '');
            localStorage.setItem('currentSheetName', currentSheetName || '');
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners...');
            
            // Header buttons
            elements.roundsBtn.addEventListener('click', showRoundsModal);
            elements.summaryBtn.addEventListener('click', showSummarySection);
            elements.createFirstRoundBtn.addEventListener('click', showRoundsModal);
            elements.loadSheetHeaderBtn.addEventListener('click', loadSheetFromHeader);
            elements.sheetSelector.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadSheetFromHeader();
            });
            elements.refreshSheetsBtn.addEventListener('click', loadAvailableSheets);

            // Rounds modal
            elements.closeRoundsModal.addEventListener('click', hideRoundsModal);
            elements.createRoundBtn.addEventListener('click', createNewRound);
            elements.newRoundName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createNewRound();
            });

            // Package form
            elements.addProductBtn.addEventListener('click', addProductItem);

            // ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            const testSaveBtn = document.getElementById('testSaveBtn');
            if (testSaveBtn) {
                testSaveBtn.addEventListener('click', () => {
                    console.log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö...');
                    console.log('üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:');
                    console.log('  - ‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:', currentRound);
                    console.log('  - ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏:', elements.packageNumber.value);
                    console.log('  - ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:', elements.shippingCost.value);
                    console.log('  - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:', elements.productList.querySelectorAll('.border').length);
                    console.log('  - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏µ‡∏ó:', sheetsData.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    
                    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    if (currentRound) {
                        showNotification('üß™ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô! ‡∏•‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'success');
                    } else {
                        showNotification('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'warning');
                    }
                });
            }

            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            console.log('üîç ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            if (elements.savePackageBtn) {
                elements.savePackageBtn.addEventListener('click', (e) => {
                    console.log('üñ±Ô∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!', e);
                    e.preventDefault();
                    savePackage();
                });
                console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            } else {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!');
            }
            
            if (elements.clearFormBtn) {
                elements.clearFormBtn.addEventListener('click', clearForm);
                console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }

            // Shipping cost calculation
            elements.shippingCost.addEventListener('input', updateCostDistribution);
            elements.costDistributionMethod.addEventListener('change', updateCostDistribution);

            // Summary
            elements.loadSheetBtn.addEventListener('click', loadSummarySheet);
            elements.summarySheetInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadSummarySheet();
            });
            elements.backToMainBtn.addEventListener('click', showPackageSection);
            elements.summaryRoundSelect.addEventListener('change', updateSummaryTable);
            elements.statusFilter.addEventListener('change', updateSummaryTable);
            elements.exportBtn.addEventListener('click', exportData);
            elements.copySummaryBtn.addEventListener('click', copySummaryData);
            elements.saveToSheetsBtn.addEventListener('click', saveToSheets);

            // Missing Products Analysis
            elements.analyzeMissingBtn.addEventListener('click', analyzeMissingProducts);
            elements.copyMissingBtn.addEventListener('click', copyMissingProducts);
            elements.showMissingDetailsBtn.addEventListener('click', showMissingDetails);
            elements.copyMissingListBtn.addEventListener('click', copyMissingProducts);
            
            // Missing Products Filter
            const missingProductsFilter = document.getElementById('missingProductsFilter');
            if (missingProductsFilter) {
                missingProductsFilter.addEventListener('change', filterMissingProducts);
            }


            // Close modal when clicking outside
            elements.roundsModal.addEventListener('click', (e) => {
                if (e.target === elements.roundsModal) hideRoundsModal();
            });
            
            console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
        }

        // Load Sheet from Header Function
        async function loadSheetFromHeader() {
            const sheetName = elements.sheetSelector.value.trim();
            if (!sheetName) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î', 'error');
                return;
            }

            elements.loadSheetHeaderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            elements.loadSheetHeaderBtn.disabled = true;

            try {
                currentSheetName = sheetName;
                await loadProductsData(sheetName);
                saveData();
                
            } catch (error) {
                console.error('Error loading sheet from header:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó: ' + error.message, 'error');
            } finally {
                elements.loadSheetHeaderBtn.innerHTML = '<i class="fas fa-search"></i>';
                elements.loadSheetHeaderBtn.disabled = false;
            }
        }

        // Load Summary Sheet Function
        async function loadSummarySheet() {
            const sheetName = elements.summarySheetInput.value.trim();
            if (!sheetName) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î', 'error');
                return;
            }

            elements.loadSheetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            elements.loadSheetBtn.disabled = true;

            try {
                const csvUrl = convertToCSVUrl(CONFIG.SHEETS_URL, sheetName);
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó "${sheetName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ`);
                
                const csvText = await response.text();
                summarySheetData = parseCSVData(csvText);
                
                if (summarySheetData.length === 0) {
                    throw new Error(`‡∏ä‡∏µ‡∏ó "${sheetName}" ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                }
                
                showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó "${sheetName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${summarySheetData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                updateSummaryTableFromSheet();
                
            } catch (error) {
                console.error('Error loading summary sheet:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó: ' + error.message, 'error');
            } finally {
                elements.loadSheetBtn.innerHTML = '<i class="fas fa-search"></i>';
                elements.loadSheetBtn.disabled = false;
            }
        }

        // Update Summary Table from Sheet Data
        function updateSummaryTableFromSheet() {
            if (summarySheetData.length === 0) {
                elements.summaryTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="py-8 px-4 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 block"></i>
                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó
                        </td>
                    </tr>
                `;
                updateSummaryStats(0, 0, 0, 0);
                return;
            }

            const statusFilter = elements.statusFilter.value;
            let completeItems = 0, missingItems = 0, excessItems = 0, totalCost = 0;
            const summaryRows = [];

            summarySheetData.forEach((product, index) => {
                const ordered = product.quantity || 0;
                const received = 0; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
                const missing = Math.max(0, ordered - received);
                const excess = Math.max(0, received - ordered);
                
                let status = '‡∏Ç‡∏≤‡∏î';
                let statusValue = 'missing';
                let diffText = `-${missing}`;
                let statusClass = 'bg-yellow-100 text-yellow-600';
                let diffClass = 'text-red-600 font-medium';
                
                if (missing > 0) {
                    missingItems++;
                } else if (excess > 0) {
                    status = '‡πÄ‡∏Å‡∏¥‡∏ô';
                    statusValue = 'excess';
                    diffText = `+${excess}`;
                    statusClass = 'bg-blue-100 text-blue-600';
                    diffClass = 'text-blue-600 font-medium';
                    excessItems++;
                } else {
                    status = '‡∏Ñ‡∏£‡∏ö';
                    statusValue = 'complete';
                    diffText = '0';
                    statusClass = 'bg-green-100 text-green-600';
                    diffClass = 'text-gray-600';
                    completeItems++;
                }

                if (statusFilter === 'all' || statusFilter === statusValue) {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';
                    
                    row.innerHTML = `
                        <td class="py-4 px-4 border-r border-gray-100">${product.code || ''}</td>
                        <td class="py-4 px-4 border-r border-gray-100">${product.name || ''}</td>
                        <td class="py-4 px-4 text-gray-600 border-r border-gray-100">${product.option || ''}</td>
                        <td class="py-4 px-4 font-medium text-blue-600 text-sm border-r border-gray-100">-</td>
                        <td class="py-4 px-4 text-center font-medium text-gray-900 border-r border-gray-100">${ordered.toLocaleString()}</td>
                        <td class="py-4 px-4 text-center font-medium text-gray-900 border-r border-gray-100">${received.toLocaleString()}</td>
                        <td class="py-4 px-4 text-center font-medium ${diffClass} border-r border-gray-100">${diffText}</td>
                        <td class="py-4 px-4 text-center font-medium text-green-600 border-r border-gray-100">0</td>
                        <td class="py-4 px-4 text-center border-r border-gray-100">
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                                ${status}
                            </span>
                        </td>
                        <td class="py-4 px-4 text-center">-</td>
                    `;
                    
                    summaryRows.push(row);
                }
            });

            elements.summaryTableBody.innerHTML = '';
            summaryRows.forEach(row => {
                elements.summaryTableBody.appendChild(row);
            });

            if (summaryRows.length === 0) {
                elements.summaryTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="py-8 px-4 text-center text-gray-500">
                            <i class="fas fa-filter text-4xl mb-2 block"></i>
                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        </td>
                    </tr>
                `;
            }

            updateSummaryStats(0, completeItems, missingItems, totalCost);
        }

        // Load available sheets from Google Sheets
        async function loadAvailableSheets() {
            elements.refreshSheetsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            elements.refreshSheetsBtn.disabled = true;
            
            try {
                // ‡πÉ‡∏ä‡πâ Google Sheets API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const sheetsApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}?key=AIzaSyDummy&fields=sheets.properties.title`;
                
                // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ (‡∏£‡∏ß‡∏°‡∏ä‡∏µ‡∏ó 19 ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á)
                const expectedSheets = ['21s', '20s', '19', '18', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏±‡∏™‡∏î‡∏∏', '‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'];
                availableSheets = [];
                
                // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏µ‡∏ó‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                for (const sheetName of expectedSheets) {
                    try {
                        const csvUrl = convertToCSVUrl(CONFIG.SHEETS_URL, sheetName);
                        const response = await fetch(csvUrl);
                        if (response.ok) {
                            const csvText = await response.text();
                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                            if (csvText && !csvText.includes('<!DOCTYPE html>') && 
                                !csvText.includes('Error') && csvText.trim().length > 10) {
                                availableSheets.push(sheetName);
                                console.log(`‚úÖ ‡∏û‡∏ö‡∏ä‡∏µ‡∏ó: ${sheetName}`);
                            } else {
                                console.log(`‚ùå ‡∏ä‡∏µ‡∏ó ${sheetName} ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ`);
                            }
                        } else {
                            console.log(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ä‡∏µ‡∏ó ${sheetName} (${response.status})`);
                        }
                    } catch (e) {
                        console.log(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö‡∏ä‡∏µ‡∏ó ${sheetName}:`, e.message);
                        continue;
                    }
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ä‡∏µ‡∏ó‡πÑ‡∏´‡∏ô‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ
                if (availableSheets.length === 0) {
                    availableSheets = expectedSheets;
                    console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
                }
                
                updateSheetSelector();
                
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á input
                if (currentSheetName) {
                    elements.sheetSelector.value = currentSheetName;
                }
                
                showNotification(`‡∏û‡∏ö ${availableSheets.length} ‡∏ä‡∏µ‡∏ó: ${availableSheets.join(', ')}`, 'success');
                
            } catch (error) {
                console.error('Error loading sheets:', error);
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ
                availableSheets = ['21s', '20s', '19', '18', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏±‡∏™‡∏î‡∏∏', '‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'];
                updateSheetSelector();
                showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏µ‡∏ó‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏•‡πâ‡∏ß', 'info');
            } finally {
                elements.refreshSheetsBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                elements.refreshSheetsBtn.disabled = false;
            }
        }

        // Update sheet selector input
        function updateSheetSelector() {
            if (currentSheetName) {
                elements.sheetSelector.value = currentSheetName;
            }
        }



        // Load products data from specific sheet
        async function loadProductsData(sheetName) {
            if (!sheetName) {
                sheetName = currentSheetName || CONFIG.DEFAULT_SHEET_NAME;
            }
            
            updateSheetStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'bg-yellow-100 text-yellow-600');
            
            try {
                const csvUrl = convertToCSVUrl(CONFIG.SHEETS_URL, sheetName);
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó "${sheetName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ`);
                
                const csvText = await response.text();
                sheetsData = parseCSVData(csvText);
                
                if (sheetsData.length === 0) {
                    throw new Error(`‡∏ä‡∏µ‡∏ó "${sheetName}" ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                }
                
                updateSheetStatus(
                    `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡∏µ‡∏ó "${sheetName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏û‡∏ö ${sheetsData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                    '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß',
                    'bg-green-100 text-green-600'
                );
                
                showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó "${sheetName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${sheetsData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                
            } catch (error) {
                console.error('Error loading products data:', error);
                sheetsData = [];
                updateSheetStatus(
                    `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó "${sheetName}": ${error.message}`,
                    '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ',
                    'bg-red-100 text-red-600'
                );
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        }

        // Update sheet connection status
        function updateSheetStatus(statusText, badgeText, badgeClass) {
            elements.sheetStatusText.textContent = statusText;
            elements.sheetStatusBadge.textContent = badgeText;
            elements.sheetStatusBadge.className = `px-3 py-1 rounded-full text-xs font-medium ${badgeClass}`;
        }

        // Convert Google Sheets URL to CSV
        function convertToCSVUrl(sheetsUrl, sheetName) {
            const match = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (!match) throw new Error('URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            const sheetId = match[1];
            return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
        }

        // Parse CSV data
        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const data = [];
            
            console.log(`üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${lines.length} ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î`);
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = parseCSVLine(line);
                if (columns.length >= 5 && columns[0] && columns[4]) {
                    const code = columns[0].trim();
                    const name = columns[1] ? columns[1].trim() : '';
                    const option = columns[2] ? columns[2].trim() : '';
                    const size = columns[3] ? columns[3].trim() : '';
                    const quantity = parseInt(columns[4]) || 0;
                    
                    data.push({ code, name, option, size, quantity });
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                    if (i <= 5) {
                        console.log(`üì¶ ${code} | ${name} | ${option} | ${size} | ${quantity} ‡∏ä‡∏¥‡πâ‡∏ô`);
                    }
                }
            }
            
            console.log(`‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à: ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const uniqueCodes = new Set(data.map(item => item.code));
            const uniqueOptions = new Set(data.map(item => `${item.code}|${item.option}`));
            console.log(`üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥: ${uniqueCodes.size} ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ${uniqueOptions.size} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`);
            
            return data;
        }

        // Parse CSV line handling quotes
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(item => item.replace(/^"|"$/g, ''));
        }

        // Update UI based on current state
        function updateUI() {
            // Show/hide sheet alert based on connection status
            if (!currentSheetName || sheetsData.length === 0) {
                elements.sheetAlert.classList.remove('hidden');
            } else {
                elements.sheetAlert.classList.add('hidden');
            }
            
            if (!currentRound) {
                elements.roundAlert.classList.remove('hidden');
                elements.packageSection.classList.add('hidden');
                elements.summarySection.classList.add('hidden');
                elements.currentRoundDisplay.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö';
                elements.roundStats.textContent = '0 ‡∏û‡∏±‡∏™‡∏î‡∏∏';
            } else {
                elements.roundAlert.classList.add('hidden');
                elements.packageSection.classList.remove('hidden');
                elements.summarySection.classList.add('hidden');
                elements.currentRoundDisplay.textContent = currentRound;
                
                const roundData = allRoundsData[currentRound];
                const packageCount = roundData ? roundData.packages.length : 0;
                elements.roundStats.textContent = packageCount + ' ‡∏û‡∏±‡∏™‡∏î‡∏∏';
            }
            
            updateRoundsList();
            updateSummaryRoundSelect();
            updateSheetSelector();
        }

        // Rounds Management
        function showRoundsModal() {
            elements.roundsModal.classList.remove('hidden');
            elements.newRoundName.focus();
        }

        function hideRoundsModal() {
            elements.roundsModal.classList.add('hidden');
            elements.newRoundName.value = '';
        }

        function createNewRound() {
            const roundName = elements.newRoundName.value.trim();
            if (!roundName) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }

            if (allRoundsData[roundName]) {
                showNotification('‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }

            allRoundsData[roundName] = {
                name: roundName,
                created: new Date().toISOString(),
                packages: []
            };

            currentRound = roundName;
            saveData();
            updateUI();
            hideRoundsModal();
            
            showNotification('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö "' + roundName + '" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function selectRound(roundName) {
            currentRound = roundName;
            saveData();
            updateUI();
            hideRoundsModal();
            showNotification('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö "' + roundName + '" ‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function deleteRound(roundName) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≠‡∏ö "' + roundName + '" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ')) {
                delete allRoundsData[roundName];
                if (currentRound === roundName) {
                    currentRound = null;
                }
                saveData();
                updateUI();
                showNotification('‡∏•‡∏ö‡∏£‡∏≠‡∏ö "' + roundName + '" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        function updateRoundsList() {
            const roundsList = elements.roundsList;
            roundsList.innerHTML = '';

            const rounds = Object.keys(allRoundsData);
            if (rounds.length === 0) {
                roundsList.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
                return;
            }

            rounds.forEach(roundName => {
                const roundData = allRoundsData[roundName];
                const isActive = roundName === currentRound;
                
                const roundItem = document.createElement('div');
                roundItem.className = `flex items-center justify-between p-3 border rounded-lg ${isActive ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'} transition-colors`;
                
                roundItem.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <h4 class="font-medium text-gray-900">${roundName}</h4>
                            ${isActive ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-600">${roundData.packages.length} ‡∏û‡∏±‡∏™‡∏î‡∏∏ ‚Ä¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date(roundData.created).toLocaleDateString('th-TH')}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${!isActive ? `<button onclick="selectRound('${roundName}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>` : ''}
                        <button onclick="deleteRound('${roundName}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">‡∏•‡∏ö</button>
                    </div>
                `;
                
                roundsList.appendChild(roundItem);
            });
        }

        function updateSummaryRoundSelect() {
            const select = elements.summaryRoundSelect;
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>';
            
            Object.keys(allRoundsData).forEach(roundName => {
                const option = document.createElement('option');
                option.value = roundName;
                option.textContent = roundName;
                if (roundName === currentRound) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Product Management
        function addProductItem() {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            const noProductsMessage = document.getElementById('noProductsMessage');
            if (noProductsMessage) {
                noProductsMessage.style.display = 'none';
            }
            
            const productItem = document.createElement('div');
            productItem.className = 'border border-gray-200 rounded-lg p-4 space-y-4 fade-in';
            
            productItem.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" class="product-code w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
                        <div class="product-suggestions absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto hidden">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥</label>
                        <select class="product-option w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</label>
                        <input type="number" class="received-qty w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" min="0">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</label>
                        <input type="number" class="ordered-qty w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</label>
                        <input type="number" class="filled-qty w-full px-3 py-2 border border-gray-300 rounded-lg bg-blue-50" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ç‡∏≤‡∏î</label>
                        <input type="number" class="missing-qty w-full px-3 py-2 border border-gray-300 rounded-lg bg-red-50" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏Å‡∏¥‡∏ô</label>
                        <input type="number" class="excess-qty w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                    </div>
                    <div class="flex items-end space-x-2">
                        <button type="button" class="duplicate-product flex-1 bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                            <i class="fas fa-clone mr-1"></i>Duplicate
                        </button>
                        <button type="button" class="remove-product flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                            <i class="fas fa-trash mr-1"></i>‡∏•‡∏ö
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="status-badge px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                        ‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </div>
                </div>
            `;

            elements.productList.appendChild(productItem);
            setupProductItemEvents(productItem);
            updateCostDistribution();
        }

        function setupProductItemEvents(productItem) {
            const codeInput = productItem.querySelector('.product-code');
            const optionSelect = productItem.querySelector('.product-option');
            const receivedInput = productItem.querySelector('.received-qty');
            const removeBtn = productItem.querySelector('.remove-product');
            const duplicateBtn = productItem.querySelector('.duplicate-product');
            const suggestions = productItem.querySelector('.product-suggestions');

            // Remove product
            removeBtn.addEventListener('click', () => {
                productItem.remove();
                updateCostDistribution();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                const remainingProducts = elements.productList.querySelectorAll('.border');
                const noProductsMessage = document.getElementById('noProductsMessage');
                if (remainingProducts.length === 0 && noProductsMessage) {
                    noProductsMessage.style.display = 'block';
                }
            });

            // Duplicate product
            duplicateBtn.addEventListener('click', () => {
                duplicateProductItem(productItem);
            });

            // Product code search
            codeInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim().toLowerCase();
                if (searchTerm.length >= 1 && sheetsData.length > 0) {
                    showProductSuggestions(productItem, searchTerm);
                } else {
                    hideSuggestions(productItem);
                }
            });

            codeInput.addEventListener('focus', (e) => {
                const searchTerm = e.target.value.trim().toLowerCase();
                if (searchTerm.length >= 1 && sheetsData.length > 0) {
                    showProductSuggestions(productItem, searchTerm);
                }
            });

            // Option change
            optionSelect.addEventListener('change', () => {
                updateProductInfo(productItem);
                updateCostDistribution();
            });

            // Received quantity change
            receivedInput.addEventListener('input', () => {
                calculateQuantities(productItem);
                updateCostDistribution();
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!productItem.contains(e.target)) {
                    hideSuggestions(productItem);
                }
            });
        }

        function showProductSuggestions(productItem, searchTerm) {
            const suggestions = productItem.querySelector('.product-suggestions');
            
            const filteredProducts = sheetsData.filter(product => {
                return product.code.toLowerCase().includes(searchTerm) || 
                       product.name.toLowerCase().includes(searchTerm);
            });

            if (filteredProducts.length === 0) {
                hideSuggestions(productItem);
                return;
            }

            const uniqueProducts = {};
            filteredProducts.forEach(product => {
                if (!uniqueProducts[product.code]) {
                    uniqueProducts[product.code] = {
                        code: product.code,
                        name: product.name,
                        options: []
                    };
                }
                if (!uniqueProducts[product.code].options.some(opt => opt.option === product.option && opt.size === product.size)) {
                    uniqueProducts[product.code].options.push({
                        option: product.option,
                        size: product.size,
                        quantity: product.quantity
                    });
                }
            });

            suggestions.innerHTML = '';
            Object.values(uniqueProducts).slice(0, 8).forEach(product => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors';
                suggestionItem.innerHTML = `
                    <div class="font-medium text-gray-900">${product.code}</div>
                    <div class="text-sm text-gray-600">${product.name}</div>
                    <div class="text-xs text-blue-600">${product.options.length} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                `;
                
                suggestionItem.addEventListener('click', () => {
                    selectProduct(productItem, product);
                });
                
                suggestions.appendChild(suggestionItem);
            });

            suggestions.classList.remove('hidden');
        }

        function hideSuggestions(productItem) {
            const suggestions = productItem.querySelector('.product-suggestions');
            suggestions.classList.add('hidden');
        }

        function selectProduct(productItem, product) {
            const codeInput = productItem.querySelector('.product-code');
            const optionSelect = productItem.querySelector('.product-option');
            
            codeInput.value = `${product.code} - ${product.name}`;
            
            optionSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>';
            
            console.log(`üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${product.code} - ${product.name}`);
            console.log(`üìã ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ: ${product.options.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            
            product.options.forEach((option, index) => {
                const optionElement = document.createElement('option');
                optionElement.value = `${option.option}|${option.size}`;
                optionElement.textContent = `${option.option} (${option.size})`;
                optionElement.setAttribute('data-quantity', option.quantity);
                optionSelect.appendChild(optionElement);
                
                console.log(`  ${index + 1}. ${option.option} (${option.size}) = ${option.quantity} ‡∏ä‡∏¥‡πâ‡∏ô`);
            });
            
            hideSuggestions(productItem);
            updateProductInfo(productItem);
            updateCostDistribution();
        }

        function updateProductInfo(productItem) {
            const optionSelect = productItem.querySelector('.product-option');
            const selectedOption = optionSelect.options[optionSelect.selectedIndex];
            const codeInput = productItem.querySelector('.product-code');
            
            if (selectedOption && selectedOption.value && codeInput) {
                const codeWithName = codeInput.value.trim();
                const code = codeWithName.split(' - ')[0];
                const [option, size] = selectedOption.value.split('|');
                
                // ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                let totalQuantity = 0;
                if (sheetsData.length > 0) {
                    console.log(`üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${code} - ${option}`);
                    
                    // ‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ + ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    const matchingProducts = sheetsData.filter(product => 
                        product.code === code && product.option === option
                    );
                    
                    console.log(`üìã ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á: ${matchingProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                    
                    matchingProducts.forEach((product, index) => {
                        const qty = product.quantity || 0;
                        totalQuantity += qty;
                        console.log(`  ${index + 1}. ${product.code} - ${product.option} (${product.size || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}): ${qty} ‡∏ä‡∏¥‡πâ‡∏ô`);
                    });
                    
                    console.log(`üìä ${code} - ${option}: ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalQuantity} ‡∏ä‡∏¥‡πâ‡∏ô ‡∏à‡∏≤‡∏Å ${matchingProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                }
                
                productItem.querySelector('.ordered-qty').value = totalQuantity;
                calculateQuantities(productItem);
            }
        }

        function calculateQuantities(productItem) {
            const received = parseInt(productItem.querySelector('.received-qty').value) || 0;
            const ordered = parseInt(productItem.querySelector('.ordered-qty').value) || 0;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ
            const codeInput = productItem.querySelector('.product-code');
            const optionSelect = productItem.querySelector('.product-option');
            
            let filled = 0;
            
            if (codeInput && optionSelect && currentRound && allRoundsData[currentRound]) {
                const codeWithName = codeInput.value.trim();
                const code = codeWithName.split(' - ')[0];
                const selectedOption = optionSelect.options[optionSelect.selectedIndex];
                const optionText = selectedOption ? selectedOption.text : '';
                
                // ‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
                const currentPackageNumber = elements.packageNumber.value.trim();
                const packages = allRoundsData[currentRound].packages || [];
                
                packages.forEach(pkg => {
                    // ‡∏Ç‡πâ‡∏≤‡∏°‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    if (pkg.packageNumber === currentPackageNumber) return;
                    
                    pkg.products.forEach(product => {
                        if (product.code === code && product.option === optionText) {
                            filled += product.received || 0;
                        }
                    });
                });
                
                console.log(`üìä ${code} - ${optionText}: ‡∏™‡∏±‡πà‡∏á=${ordered}, ‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß=${filled}, ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ=${received}`);
            }
            
            // ‡∏Ç‡∏≤‡∏î = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á - (‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß + ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ)
            const totalReceived = filled + received;
            const missing = Math.max(0, ordered - totalReceived);
            const excess = Math.max(0, totalReceived - ordered);

            productItem.querySelector('.filled-qty').value = filled;
            productItem.querySelector('.missing-qty').value = missing;
            productItem.querySelector('.excess-qty').value = excess;

            const statusBadge = productItem.querySelector('.status-badge');
            if (totalReceived === ordered) {
                statusBadge.className = 'status-badge px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-600';
                statusBadge.textContent = '‡∏Ñ‡∏£‡∏ö';
            } else if (totalReceived < ordered) {
                statusBadge.className = 'status-badge px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-600';
                statusBadge.textContent = '‡∏Ç‡∏≤‡∏î';
            } else {
                statusBadge.className = 'status-badge px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-600';
                statusBadge.textContent = '‡πÄ‡∏Å‡∏¥‡∏ô';
            }
        }

        // Duplicate Product Item Function
        function duplicateProductItem(sourceItem) {
            const codeInput = sourceItem.querySelector('.product-code');
            const optionSelect = sourceItem.querySelector('.product-option');
            
            const codeWithName = (codeInput && codeInput.value) ? codeInput.value.trim() : '';
            const selectedOptionText = optionSelect && optionSelect.selectedIndex > 0 ? optionSelect.options[optionSelect.selectedIndex].text : '';
            
            if (!codeWithName) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô Duplicate', 'warning');
                return;
            }

            console.log('üîÑ Duplicate ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:', codeWithName);
            console.log('üìã ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:', selectedOptionText);

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            const noProductsMessage = document.getElementById('noProductsMessage');
            if (noProductsMessage) {
                noProductsMessage.style.display = 'none';
            }

            // Clone ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const clonedItem = sourceItem.cloneNode(true);
            clonedItem.classList.add('fade-in');
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà)
            const clonedReceivedInput = clonedItem.querySelector('.received-qty');
            if (clonedReceivedInput) {
                clonedReceivedInput.value = '';
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ (filled, missing, excess)
            const clonedFilledInput = clonedItem.querySelector('.filled-qty');
            const clonedMissingInput = clonedItem.querySelector('.missing-qty');
            const clonedExcessInput = clonedItem.querySelector('.excess-qty');
            
            if (clonedFilledInput) clonedFilledInput.value = '';
            if (clonedMissingInput) clonedMissingInput.value = '';
            if (clonedExcessInput) clonedExcessInput.value = '';
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            const clonedStatusBadge = clonedItem.querySelector('.status-badge');
            if (clonedStatusBadge) {
                clonedStatusBadge.className = 'status-badge px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600';
                clonedStatusBadge.textContent = '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà clone ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            elements.productList.appendChild(clonedItem);
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà clone
            setupProductItemEvents(clonedItem);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà clone
            updateProductInfo(clonedItem);
            updateCostDistribution();
            
            // Focus ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            setTimeout(() => {
                if (clonedReceivedInput) {
                    clonedReceivedInput.focus();
                    clonedReceivedInput.select();
                }
            }, 100);
            
            const code = codeWithName.split(' - ')[0];
            showNotification(`‚úÖ Duplicate ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${code}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ${selectedOptionText ? `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "${selectedOptionText}"` : ''}\nüí° ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà`, 'success');
        }

        function updateCostDistribution() {
            const totalCost = parseFloat(elements.shippingCost.value) || 0;
            const method = elements.costDistributionMethod.value;
            const productItems = elements.productList.querySelectorAll('.border');
            
            if (totalCost === 0 || productItems.length === 0) {
                elements.shippingDistribution.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</p>';
                elements.totalDistributed.textContent = '0';
                elements.remainingCost.textContent = '0';
                return;
            }

            elements.shippingDistribution.innerHTML = '';
            let distributedTotal = 0;

            if (method === 'proportion') {
                let totalQuantity = 0;
                const productData = [];

                productItems.forEach(item => {
                    const codeInput = item.querySelector('.product-code');
                    const receivedInput = item.querySelector('.received-qty');
                    
                    const codeWithName = (codeInput && codeInput.value) ? codeInput.value.trim() : '';
                    const code = codeWithName.split(' - ')[0];
                    const received = (receivedInput && receivedInput.value) ? parseInt(receivedInput.value) : 0;
                    
                    if (code) {
                        productData.push({ code, received, item });
                        totalQuantity += received;
                    }
                });

                if (totalQuantity > 0) {
                    productData.forEach((product, index) => {
                        let allocatedCost = 0;
                        if (product.received > 0) {
                            const proportion = product.received / totalQuantity;
                            allocatedCost = Math.round(totalCost * proportion);
                        }
                        
                        distributedTotal += allocatedCost;

                        if (index === productData.length - 1 && product.received > 0) {
                            const adjustment = totalCost - distributedTotal;
                            allocatedCost += adjustment;
                            distributedTotal += adjustment;
                        }

                        createDistributionItem(product.code, product.received, allocatedCost, false);
                        product.item.setAttribute('data-shipping-cost', allocatedCost);
                    });
                }
            } else if (method === 'equal') {
                const productData = [];
                productItems.forEach(item => {
                    const codeInput = item.querySelector('.product-code');
                    const receivedInput = item.querySelector('.received-qty');
                    
                    const codeWithName = (codeInput && codeInput.value) ? codeInput.value.trim() : '';
                    const code = codeWithName.split(' - ')[0];
                    const received = (receivedInput && receivedInput.value) ? parseInt(receivedInput.value) : 0;
                    
                    if (code) {
                        productData.push({ code, received, item });
                    }
                });

                if (productData.length > 0) {
                    const costPerProduct = Math.round(totalCost / productData.length);
                    productData.forEach((product, index) => {
                        let allocatedCost = costPerProduct;
                        if (index === productData.length - 1) {
                            allocatedCost = totalCost - (distributedTotal);
                        }
                        distributedTotal += allocatedCost;
                        createDistributionItem(product.code, product.received, allocatedCost, false);
                        product.item.setAttribute('data-shipping-cost', allocatedCost);
                    });
                }
            } else {
                // Custom distribution
                productItems.forEach(item => {
                    const codeInput = item.querySelector('.product-code');
                    const receivedInput = item.querySelector('.received-qty');
                    
                    const codeWithName = (codeInput && codeInput.value) ? codeInput.value.trim() : '';
                    const code = codeWithName.split(' - ')[0];
                    const received = (receivedInput && receivedInput.value) ? parseInt(receivedInput.value) : 0;
                    
                    if (code) {
                        const currentCost = parseInt(item.getAttribute('data-shipping-cost')) || 0;
                        createDistributionItem(code, received, currentCost, true);
                        distributedTotal += currentCost;
                    }
                });
            }

            elements.totalDistributed.textContent = distributedTotal.toLocaleString();
            elements.remainingCost.textContent = (totalCost - distributedTotal).toLocaleString();
            
            if (Math.abs(totalCost - distributedTotal) > 0.01) {
                elements.remainingCost.className = 'font-medium text-red-600';
            } else {
                elements.remainingCost.className = 'font-medium text-green-600';
            }
        }

        function createDistributionItem(code, quantity, cost, isEditable) {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
            
            const costInput = isEditable ? 
                `<input type="number" value="${cost}" class="shipping-cost-input w-24 px-2 py-1 border border-gray-300 rounded text-right text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" data-product-code="${code}">` :
                `<span class="font-medium text-gray-900">${cost.toLocaleString()}</span>`;

            item.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="font-medium text-blue-600">${code}</span>
                    <span class="text-sm text-gray-600">(${quantity.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô)</span>
                </div>
                <div class="flex items-center space-x-2">
                    ${costInput}
                    <span class="text-sm text-gray-600">‡∏ö‡∏≤‡∏ó</span>
                </div>
            `;

            elements.shippingDistribution.appendChild(item);

            if (isEditable) {
                const input = item.querySelector('.shipping-cost-input');
                input.addEventListener('input', (e) => {
                    const newCost = parseInt(e.target.value) || 0;
                    const productCode = e.target.getAttribute('data-product-code');
                    
                    const productItem = Array.from(elements.productList.querySelectorAll('.border')).find(item => {
                        const codeInput = item.querySelector('.product-code');
                        return codeInput && codeInput.value.trim().startsWith(productCode);
                    });
                    
                    if (productItem) {
                        productItem.setAttribute('data-shipping-cost', newCost);
                    }
                    
                    updateDistributionTotals();
                });
            }
        }

        function updateDistributionTotals() {
            const inputs = elements.shippingDistribution.querySelectorAll('.shipping-cost-input');
            let total = 0;
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            
            const totalCost = parseFloat(elements.shippingCost.value) || 0;
            elements.totalDistributed.textContent = total.toLocaleString();
            elements.remainingCost.textContent = (totalCost - total).toLocaleString();
            
            if (Math.abs(totalCost - total) > 0.01) {
                elements.remainingCost.className = 'font-medium text-red-600';
            } else {
                elements.remainingCost.className = 'font-medium text-green-600';
            }
        }

        // Package Management
        function savePackage() {
            console.log('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏...');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (!currentRound) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            console.log('‚úÖ ‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:', currentRound);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏
            const packageNumber = elements.packageNumber.value.trim();
            if (!packageNumber) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏');
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏', 'error');
                elements.packageNumber.focus();
                return;
            }
            console.log('‚úÖ ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏:', packageNumber);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const productItems = elements.productList.querySelectorAll('.border');
            console.log('üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°:', productItems.length);
            
            if (productItems.length === 0) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
                return;
            }

            const products = [];
            let hasValidProduct = false;
            let validationErrors = [];

            productItems.forEach((item, index) => {
                console.log(`üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà ${index + 1}:`);
                
                const codeInput = item.querySelector('.product-code');
                const optionSelect = item.querySelector('.product-option');
                const receivedInput = item.querySelector('.received-qty');
                const orderedInput = item.querySelector('.ordered-qty');
                
                const codeWithName = (codeInput && codeInput.value) ? codeInput.value.trim() : '';
                const code = codeWithName ? codeWithName.split(' - ')[0] : '';
                const name = codeWithName.includes(' - ') ? codeWithName.split(' - ')[1] : getProductName(code);
                const optionText = (optionSelect && optionSelect.options[optionSelect.selectedIndex]) ? optionSelect.options[optionSelect.selectedIndex].text : '';
                const received = (receivedInput && receivedInput.value) ? parseInt(receivedInput.value) : 0;
                const ordered = (orderedInput && orderedInput.value) ? parseInt(orderedInput.value) : 0;
                
                console.log(`  - ‡∏£‡∏´‡∏±‡∏™: "${code}"`);
                console.log(`  - ‡∏ä‡∏∑‡πà‡∏≠: "${name}"`);
                console.log(`  - ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: "${optionText}"`);
                console.log(`  - ‡πÑ‡∏î‡πâ: ${received}`);
                console.log(`  - ‡∏™‡∏±‡πà‡∏á: ${ordered}`);
                
                // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                if (!code && !optionText && received === 0) {
                    console.log(`  ‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á`);
                    return;
                }
                
                if (!code) {
                    validationErrors.push(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà ${index + 1}: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤`);
                    return;
                }
                
                if (!optionText) {
                    validationErrors.push(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà ${index + 1} (${code}): ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥`);
                    return;
                }
                
                if (received < 0) {
                    validationErrors.push(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà ${index + 1} (${code}): ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö`);
                    return;
                }

                hasValidProduct = true;
                const missing = Math.max(0, ordered - received);
                const excess = Math.max(0, received - ordered);
                const shippingCost = parseInt(item.getAttribute('data-shipping-cost')) || 0;
                
                const productData = {
                    code,
                    name,
                    option: optionText || '-',
                    received,
                    ordered,
                    missing,
                    excess,
                    shippingCost
                };
                
                products.push(productData);
                console.log(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:`, productData);
            });

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (validationErrors.length > 0) {
                console.error('‚ùå ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', validationErrors);
                showNotification('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n' + validationErrors.join('\n'), 'error');
                return;
            }

            if (!hasValidProduct) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ã‡πâ‡∏≥
            if (allRoundsData[currentRound] && allRoundsData[currentRound].packages) {
                const existingPackage = allRoundsData[currentRound].packages.find(pkg => pkg.packageNumber === packageNumber);
                if (existingPackage) {
                    if (!confirm(`‡∏û‡∏±‡∏™‡∏î‡∏∏ "${packageNumber}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                        return;
                    }
                    // ‡∏•‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏î‡∏¥‡∏°
                    allRoundsData[currentRound].packages = allRoundsData[currentRound].packages.filter(pkg => pkg.packageNumber !== packageNumber);
                    console.log('üîÑ ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏î‡∏¥‡∏°');
                }
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏±‡∏™‡∏î‡∏∏
            const packageData = {
                id: Date.now(),
                packageNumber,
                products,
                shippingCost: parseFloat(elements.shippingCost.value) || 0,
                timestamp: new Date().toISOString(),
                dateCreated: new Date().toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };

            console.log('üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:', packageData);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
            if (!allRoundsData[currentRound]) {
                allRoundsData[currentRound] = {
                    name: currentRound,
                    created: new Date().toISOString(),
                    packages: []
                };
                console.log('üÜï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà:', currentRound);
            }

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏
            try {
                allRoundsData[currentRound].packages.push(packageData);
                saveData();
                updateUI();
                
                console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                console.log('üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ô‡∏£‡∏≠‡∏ö:', allRoundsData[currentRound].packages.length);
                
                showNotification(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏ "${packageNumber}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\nüì¶ ${products.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\nüí∞ ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${packageData.shippingCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó`, 'success');
                
                // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                setTimeout(() => {
                    clearForm();
                    addProductItem();
                    elements.packageNumber.focus();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message, 'error');
            }
        }

        function clearForm() {
            elements.packageNumber.value = '';
            elements.shippingCost.value = '';
            elements.productList.innerHTML = `
                <div id="noProductsMessage" class="text-center py-8 text-gray-500">
                    <i class="fas fa-plus-circle text-4xl mb-3 text-gray-300"></i>
                    <p class="text-lg font-medium mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏</p>
                    <p class="text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                </div>
            `;
            elements.shippingDistribution.innerHTML = '';
            elements.totalDistributed.textContent = '0';
            elements.remainingCost.textContent = '0';
        }

        function getProductName(code) {
            if (sheetsData.length > 0) {
                const product = sheetsData.find(p => p.code === code);
                return product ? product.name : '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            }
            return '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        }

        // Copy Summary Data Function - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function copySummaryData() {
            const selectedRound = elements.summaryRoundSelect.value;
            const sheetName = elements.summarySheetInput.value.trim();
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó
            if (sheetName && summarySheetData.length > 0) {
                copySummaryFromSheet();
                return;
            }
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (!selectedRound || !allRoundsData[selectedRound]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }

            const roundData = allRoundsData[selectedRound];
            const packages = roundData.packages || [];
            
            if (packages.length === 0) {
                showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 'error');
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            let tableData = [];
            
            // Header rows - 2 ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            tableData.push([
                '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '', '', '‡∏û‡∏±‡∏™‡∏î‡∏∏', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '', '', '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', ''
            ]);
            
            tableData.push([
                '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 
                '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
                '‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏',
                '‡∏™‡∏±‡πà‡∏á (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)',
                '‡πÑ‡∏î‡πâ',
                '‡∏ï‡πà‡∏≤‡∏á',
                '‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó)',
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
                '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'
            ]);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const productGroups = {};
            
            packages.forEach(pkg => {
                pkg.products.forEach((product) => {
                    const key = `${product.code}|${product.name}|${product.option}`;
                    
                    if (!productGroups[key]) {
                        productGroups[key] = {
                            code: product.code || '',
                            name: product.name || '',
                            option: product.option || '-',
                            ordered: product.ordered || 0,
                            received: 0,
                            shippingCost: 0,
                            packageNumbers: []
                        };
                    }
                    
                    productGroups[key].received += product.received || 0;
                    productGroups[key].shippingCost += product.shippingCost || 0;
                    productGroups[key].packageNumbers.push(pkg.packageNumber);
                });
            });

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å
            const codeGroups = {};
            Object.values(productGroups).forEach(product => {
                if (!codeGroups[product.code]) {
                    codeGroups[product.code] = {
                        code: product.code,
                        name: product.name,
                        products: [],
                        totalOrdered: 0,
                        totalReceived: 0,
                        totalShippingCost: 0
                    };
                }
                codeGroups[product.code].products.push(product);
                codeGroups[product.code].totalOrdered += product.ordered;
                codeGroups[product.code].totalReceived += product.received;
                codeGroups[product.code].totalShippingCost += product.shippingCost;
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const sortedCodes = Object.keys(codeGroups).sort();

            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
            sortedCodes.forEach(code => {
                const codeGroup = codeGroups[code];
                const hasMultipleOptions = codeGroup.products.length > 1;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
                codeGroup.products.sort((a, b) => a.option.localeCompare(b.option));
                
                codeGroup.products.forEach((product, optionIndex) => {
                    const missing = Math.max(0, product.ordered - product.received);
                    const excess = Math.max(0, product.received - product.ordered);
                    
                    let status = '‡∏Ñ‡∏£‡∏ö';
                    let diffText = '0';
                    
                    if (missing > 0) {
                        status = '‡∏Ç‡∏≤‡∏î';
                        diffText = `-${missing}`;
                    } else if (excess > 0) {
                        status = '‡πÄ‡∏Å‡∏¥‡∏ô';
                        diffText = `+${excess}`;
                    }

                    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    const packageDisplay = [...new Set(product.packageNumbers)].join(', ');
                    
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    let codeDisplay = product.code;
                    let nameDisplay = product.name;
                    let optionDisplay = product.option;
                    
                    if (hasMultipleOptions) {
                        if (optionIndex === 0) {
                            // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å - ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°
                            codeDisplay = `${product.code} (‡∏´‡∏•‡∏±‡∏Å)`;
                            nameDisplay = `${product.name} [‡∏£‡∏ß‡∏° ${codeGroup.products.length} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å]`;
                            optionDisplay = `‚Ü≥ ${product.option}`;
                        } else {
                            // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            codeDisplay = `‚îî‚îÄ ${product.code}`;
                            nameDisplay = `‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô`;
                            optionDisplay = `‚Ü≥ ${product.option}`;
                        }
                    }
                    
                    tableData.push([
                        codeDisplay,
                        nameDisplay,
                        optionDisplay,
                        packageDisplay,
                        product.ordered.toString(),
                        product.received.toString(),
                        diffText,
                        product.shippingCost.toString(),
                        status,
                        '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö'
                    ]);
                });
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                if (hasMultipleOptions) {
                    const totalMissing = Math.max(0, codeGroup.totalOrdered - codeGroup.totalReceived);
                    const totalExcess = Math.max(0, codeGroup.totalReceived - codeGroup.totalOrdered);
                    let totalDiffText = '0';
                    
                    if (totalMissing > 0) {
                        totalDiffText = `-${totalMissing}`;
                    } else if (totalExcess > 0) {
                        totalDiffText = `+${totalExcess}`;
                    }
                    
                    let totalStatus = '‡∏Ñ‡∏£‡∏ö';
                    if (totalMissing > 0) {
                        totalStatus = '‡∏Ç‡∏≤‡∏î';
                    } else if (totalExcess > 0) {
                        totalStatus = '‡πÄ‡∏Å‡∏¥‡∏ô';
                    }
                    
                    tableData.push([
                        `üìä ‡∏£‡∏ß‡∏° ${codeGroup.code}`,
                        `${codeGroup.products.length} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`,
                        '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                        '-',
                        codeGroup.totalOrdered.toString(),
                        codeGroup.totalReceived.toString(),
                        totalDiffText,
                        codeGroup.totalShippingCost.toString(),
                        totalStatus,
                        '‡∏™‡∏£‡∏∏‡∏õ'
                    ]);
                }
            });

            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô TSV (Tab-separated values) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Sheets
            const tsvContent = tableData.map(row => row.join('\t')).join('\n');
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
            const totalPackages = packages.length;
            let totalOrdered = 0, totalReceived = 0, totalCost = 0;
            
            packages.forEach(pkg => {
                totalCost += pkg.shippingCost || 0;
                pkg.products.forEach(product => {
                    totalOrdered += product.ordered || 0;
                    totalReceived += product.received || 0;
                });
            });

            const summaryData = [
                '',
                `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ - ‡∏£‡∏≠‡∏ö: ${selectedRound}`,
                `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}`,
                '',
                '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°:',
                `‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalPackages} ‡∏û‡∏±‡∏™‡∏î‡∏∏`,
                `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${Object.keys(productGroups).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á: ${totalOrdered.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô`,
                `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: ${totalReceived.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô`,
                `‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ß‡∏°: ${totalCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó`
            ];

            const finalContent = tsvContent + '\n\n' + summaryData.join('\n');

            // Copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(finalContent).then(() => {
                    showNotification('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Google Sheets ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)', 'success');
                }).catch(() => {
                    fallbackCopyTextToClipboard(finalContent);
                });
            } else {
                fallbackCopyTextToClipboard(finalContent);
            }
        }

        // Copy Summary from Sheet Data
        function copySummaryFromSheet() {
            if (summarySheetData.length === 0) {
                showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 'error');
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            let tableData = [];
            
            // Header rows - 2 ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            tableData.push([
                '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '', '', '‡∏û‡∏±‡∏™‡∏î‡∏∏', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '', '', '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', ''
            ]);
            
            tableData.push([
                '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 
                '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
                '‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏',
                '‡∏™‡∏±‡πà‡∏á (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)',
                '‡πÑ‡∏î‡πâ',
                '‡∏ï‡πà‡∏≤‡∏á',
                '‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó)',
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
                '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'
            ]);

            // Data rows ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó
            summarySheetData.forEach((product) => {
                const ordered = product.quantity || 0;
                const received = 0; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
                const missing = Math.max(0, ordered - received);
                
                let status = '‡∏Ç‡∏≤‡∏î';
                let diffText = `-${missing}`;
                
                tableData.push([
                    product.code || '',
                    product.name || '',
                    product.option || '',
                    '-',
                    ordered.toString(),
                    received.toString(),
                    diffText,
                    '0',
                    status,
                    '-'
                ]);
            });

            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô TSV (Tab-separated values) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Sheets
            const tsvContent = tableData.map(row => row.join('\t')).join('\n');
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
            const sheetName = elements.summarySheetInput.value.trim();
            const totalOrdered = summarySheetData.reduce((sum, product) => sum + (product.quantity || 0), 0);

            const summaryData = [
                '',
                `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ - ‡∏ä‡∏µ‡∏ó: ${sheetName}`,
                `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}`,
                '',
                '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°:',
                `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${summarySheetData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á: ${totalOrdered.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô`,
                `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: 0 ‡∏ä‡∏¥‡πâ‡∏ô`,
                `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î: ${totalOrdered.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô`
            ];

            const finalContent = tsvContent + '\n\n' + summaryData.join('\n');

            // Copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(finalContent).then(() => {
                    showNotification('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Google Sheets ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'success');
                }).catch(() => {
                    fallbackCopyTextToClipboard(finalContent);
                });
            } else {
                fallbackCopyTextToClipboard(finalContent);
            }
        }

        // Fallback copy function
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Google Sheets ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'success');
            } catch (err) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 'error');
                console.error('Fallback copy failed:', err);
            }
            
            document.body.removeChild(textArea);
        }

        // Summary Section
        function showSummarySection() {
            elements.packageSection.classList.add('hidden');
            elements.summarySection.classList.remove('hidden');
            elements.roundAlert.classList.add('hidden');
            elements.sheetAlert.classList.add('hidden');
            
            updateSummaryRoundSelect();
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            if (currentRound) {
                elements.summaryRoundSelect.value = currentRound;
                updateSummaryTable();
            }
        }

        function showPackageSection() {
            elements.summarySection.classList.add('hidden');
            elements.packageSection.classList.remove('hidden');
            updateUI();
        }

        function updateSummaryTable() {
            const selectedRound = elements.summaryRoundSelect.value;
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó
            if (summarySheetData.length > 0) {
                updateSummaryTableFromSheet();
                return;
            }
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (!selectedRound || !allRoundsData[selectedRound]) {
                elements.summaryTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="py-8 px-4 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 block"></i>
                            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó
                        </td>
                    </tr>
                `;
                updateSummaryStats(0, 0, 0, 0);
                return;
            }

            const roundData = allRoundsData[selectedRound];
            const packages = roundData.packages || [];
            
            if (packages.length === 0) {
                elements.summaryTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="py-8 px-4 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 block"></i>
                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
                        </td>
                    </tr>
                `;
                updateSummaryStats(0, 0, 0, 0);
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const productGroups = {};
            let totalCost = 0;
            
            packages.forEach(pkg => {
                totalCost += pkg.shippingCost || 0;
                pkg.products.forEach((product) => {
                    const key = `${product.code}|${product.name}|${product.option}`;
                    
                    if (!productGroups[key]) {
                        productGroups[key] = {
                            code: product.code || '',
                            name: product.name || '',
                            option: product.option || '-',
                            ordered: product.ordered || 0,
                            received: 0,
                            shippingCost: 0,
                            packageNumbers: []
                        };
                    }
                    
                    productGroups[key].received += product.received || 0;
                    productGroups[key].shippingCost += product.shippingCost || 0;
                    productGroups[key].packageNumbers.push(pkg.packageNumber);
                });
            });

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å
            const codeGroups = {};
            Object.values(productGroups).forEach(product => {
                if (!codeGroups[product.code]) {
                    codeGroups[product.code] = {
                        code: product.code,
                        name: product.name,
                        products: [],
                        totalOrdered: 0,
                        totalReceived: 0,
                        totalShippingCost: 0
                    };
                }
                codeGroups[product.code].products.push(product);
                codeGroups[product.code].totalOrdered += product.ordered;
                codeGroups[product.code].totalReceived += product.received;
                codeGroups[product.code].totalShippingCost += product.shippingCost;
            });

            const statusFilter = elements.statusFilter.value;
            let completeItems = 0, missingItems = 0, excessItems = 0;
            const summaryRows = [];

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const sortedCodes = Object.keys(codeGroups).sort();

            sortedCodes.forEach(code => {
                const codeGroup = codeGroups[code];
                const hasMultipleOptions = codeGroup.products.length > 1;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
                codeGroup.products.sort((a, b) => a.option.localeCompare(b.option));
                
                codeGroup.products.forEach((product, optionIndex) => {
                    const missing = Math.max(0, product.ordered - product.received);
                    const excess = Math.max(0, product.received - product.ordered);
                    
                    let status = '‡∏Ñ‡∏£‡∏ö';
                    let statusValue = 'complete';
                    let diffText = '0';
                    let statusClass = 'bg-green-100 text-green-600';
                    let diffClass = 'text-gray-600';
                    
                    if (missing > 0) {
                        status = '‡∏Ç‡∏≤‡∏î';
                        statusValue = 'missing';
                        diffText = `-${missing}`;
                        statusClass = 'bg-yellow-100 text-yellow-600';
                        diffClass = 'text-red-600 font-medium';
                        missingItems++;
                    } else if (excess > 0) {
                        status = '‡πÄ‡∏Å‡∏¥‡∏ô';
                        statusValue = 'excess';
                        diffText = `+${excess}`;
                        statusClass = 'bg-blue-100 text-blue-600';
                        diffClass = 'text-blue-600 font-medium';
                        excessItems++;
                    } else {
                        completeItems++;
                    }

                    if (statusFilter === 'all' || statusFilter === statusValue) {
                        const row = document.createElement('tr');
                        
                        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                        const packageDisplay = [...new Set(product.packageNumbers)].join(', ');
                        
                        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        let codeDisplay = product.code;
                        let nameDisplay = product.name;
                        let optionDisplay = product.option;
                        let rowClass = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';
                        
                        if (hasMultipleOptions) {
                            if (optionIndex === 0) {
                                // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å - ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°
                                codeDisplay = `üì¶ ${product.code}`;
                                nameDisplay = `${product.name} [${codeGroup.products.length} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å]`;
                                optionDisplay = `‚îî‚îÄ ${product.option}`;
                                rowClass = 'border-b border-gray-200 hover:bg-blue-25 transition-colors bg-blue-50';
                            } else {
                                // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                                codeDisplay = `   ‚îî‚îÄ ${product.code}`;
                                nameDisplay = `‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô`;
                                optionDisplay = `‚îî‚îÄ ${product.option}`;
                                rowClass = 'border-b border-gray-100 hover:bg-gray-25 transition-colors';
                            }
                        }
                        
                        row.className = rowClass;
                        
                        row.innerHTML = `
                            <td class="py-3 px-4 border-r border-gray-100 ${hasMultipleOptions && optionIndex === 0 ? 'font-semibold text-blue-800' : ''}">${codeDisplay}</td>
                            <td class="py-3 px-4 border-r border-gray-100 ${hasMultipleOptions && optionIndex === 0 ? 'font-semibold text-blue-800' : ''}">${nameDisplay}</td>
                            <td class="py-3 px-4 text-gray-600 border-r border-gray-100 ${hasMultipleOptions ? 'text-sm' : ''}">${optionDisplay}</td>
                            <td class="py-3 px-4 font-medium text-blue-600 text-sm border-r border-gray-100">${packageDisplay}</td>
                            <td class="py-3 px-4 text-center font-medium text-gray-900 border-r border-gray-100">${product.ordered.toLocaleString()}</td>
                            <td class="py-3 px-4 text-center font-medium text-gray-900 border-r border-gray-100">${product.received.toLocaleString()}</td>
                            <td class="py-3 px-4 text-center font-medium ${diffClass} border-r border-gray-100">${diffText}</td>
                            <td class="py-3 px-4 text-center font-medium text-green-600 border-r border-gray-100">${product.shippingCost.toLocaleString()}</td>
                            <td class="py-3 px-4 text-center border-r border-gray-100">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                    ${status}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-center">
                                <button onclick="editProduct('${selectedRound}', '${product.code}', '${product.option.replace(/'/g, "\\'")}', '${packageDisplay}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fas fa-edit mr-1"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                            </td>
                        `;
                        
                        summaryRows.push(row);
                    }
                });
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                if (hasMultipleOptions && (statusFilter === 'all' || 
                    (statusFilter === 'complete' && codeGroup.totalReceived === codeGroup.totalOrdered) ||
                    (statusFilter === 'missing' && codeGroup.totalReceived < codeGroup.totalOrdered) ||
                    (statusFilter === 'excess' && codeGroup.totalReceived > codeGroup.totalOrdered))) {
                    
                    const totalMissing = Math.max(0, codeGroup.totalOrdered - codeGroup.totalReceived);
                    const totalExcess = Math.max(0, codeGroup.totalReceived - codeGroup.totalOrdered);
                    let totalStatus = '‡∏Ñ‡∏£‡∏ö';
                    let totalStatusClass = 'bg-green-100 text-green-600';
                    let totalDiffText = '0';
                    let totalDiffClass = 'text-gray-600';
                    
                    if (totalMissing > 0) {
                        totalStatus = '‡∏Ç‡∏≤‡∏î';
                        totalStatusClass = 'bg-yellow-100 text-yellow-600';
                        totalDiffText = `-${totalMissing}`;
                        totalDiffClass = 'text-red-600 font-medium';
                    } else if (totalExcess > 0) {
                        totalStatus = '‡πÄ‡∏Å‡∏¥‡∏ô';
                        totalStatusClass = 'bg-blue-100 text-blue-600';
                        totalDiffText = `+${totalExcess}`;
                        totalDiffClass = 'text-blue-600 font-medium';
                    }
                    
                    const summaryRow = document.createElement('tr');
                    summaryRow.className = 'border-b-2 border-blue-300 bg-blue-100 hover:bg-blue-150 transition-colors';
                    
                    summaryRow.innerHTML = `
                        <td class="py-3 px-4 border-r border-gray-100 font-bold text-blue-900">üìä ‡∏£‡∏ß‡∏° ${codeGroup.code}</td>
                        <td class="py-3 px-4 border-r border-gray-100 font-bold text-blue-900">${codeGroup.products.length} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td>
                        <td class="py-3 px-4 text-blue-700 border-r border-gray-100 font-medium">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                        <td class="py-3 px-4 font-medium text-blue-600 text-sm border-r border-gray-100">-</td>
                        <td class="py-3 px-4 text-center font-bold text-blue-900 border-r border-gray-100">${codeGroup.totalOrdered.toLocaleString()}</td>
                        <td class="py-3 px-4 text-center font-bold text-blue-900 border-r border-gray-100">${codeGroup.totalReceived.toLocaleString()}</td>
                        <td class="py-3 px-4 text-center font-bold ${totalDiffClass} border-r border-gray-100">${totalDiffText}</td>
                        <td class="py-3 px-4 text-center font-bold text-green-700 border-r border-gray-100">${codeGroup.totalShippingCost.toLocaleString()}</td>
                        <td class="py-3 px-4 text-center border-r border-gray-100">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${totalStatusClass}">
                                ${totalStatus}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center text-blue-700 font-medium">‡∏™‡∏£‡∏∏‡∏õ</td>
                    `;
                    
                    summaryRows.push(summaryRow);
                }
            });

            elements.summaryTableBody.innerHTML = '';
            summaryRows.forEach(row => {
                elements.summaryTableBody.appendChild(row);
            });

            if (summaryRows.length === 0) {
                elements.summaryTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="py-8 px-4 text-center text-gray-500">
                            <i class="fas fa-filter text-4xl mb-2 block"></i>
                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        </td>
                    </tr>
                `;
            }

            updateSummaryStats(packages.length, completeItems, missingItems, totalCost);
        }

        function updateSummaryStats(totalPackages, completeItems, missingItems, totalCost) {
            elements.totalPackages.textContent = totalPackages.toLocaleString();
            elements.completeItems.textContent = completeItems.toLocaleString();
            elements.missingItems.textContent = missingItems.toLocaleString();
            elements.totalCost.textContent = totalCost.toLocaleString();
        }



        // Export and Save Functions
        function exportData() {
            const selectedRound = elements.summaryRoundSelect.value;
            if (!selectedRound || !allRoundsData[selectedRound]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }

            const roundData = allRoundsData[selectedRound];
            const dataStr = JSON.stringify(roundData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤_${selectedRound}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        async function saveToSheets() {
            const selectedRound = elements.summaryRoundSelect.value;
            if (!selectedRound || !allRoundsData[selectedRound]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }

            elements.saveToSheetsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            elements.saveToSheetsBtn.disabled = true;

            try {
                const roundData = allRoundsData[selectedRound];
                const summaryData = prepareSummaryForSheets(roundData);
                
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveSummary',
                        sheetName: CONFIG.SUMMARY_SHEET_NAME,
                        data: summaryData,
                        roundName: selectedRound
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } else {
                    throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                }
            } catch (error) {
                console.error('Error saving to sheets:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Google Sheets ‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            } finally {
                elements.saveToSheetsBtn.innerHTML = '<i class="fas fa-cloud-upload mr-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Sheets';
                elements.saveToSheetsBtn.disabled = false;
            }
        }

        function prepareSummaryForSheets(roundData) {
            const packages = roundData.packages || [];
            const summaryData = [];
            
            // Header
            summaryData.push([
                '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', '‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏', 
                '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ', '‡∏Ç‡∏≤‡∏î/‡πÄ‡∏Å‡∏¥‡∏ô', '‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'
            ]);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
            const productGroups = {};
            
            packages.forEach(pkg => {
                pkg.products.forEach((product) => {
                    const key = `${product.code}|${product.name}|${product.option}`;
                    
                    if (!productGroups[key]) {
                        productGroups[key] = {
                            code: product.code || '',
                            name: product.name || '',
                            option: product.option || '-',
                            ordered: product.ordered || 0,
                            received: 0,
                            shippingCost: 0,
                            packageNumbers: []
                        };
                    }
                    
                    productGroups[key].received += product.received || 0;
                    productGroups[key].shippingCost += product.shippingCost || 0;
                    productGroups[key].packageNumbers.push(pkg.packageNumber);
                });
            });

            // Data rows
            Object.values(productGroups).forEach((product) => {
                const missing = Math.max(0, product.ordered - product.received);
                const excess = Math.max(0, product.received - product.ordered);
                
                let status = '‡∏Ñ‡∏£‡∏ö';
                let diffText = '0';
                
                if (missing > 0) {
                    status = '‡∏Ç‡∏≤‡∏î';
                    diffText = `-${missing}`;
                } else if (excess > 0) {
                    status = '‡πÄ‡∏Å‡∏¥‡∏ô';
                    diffText = `+${excess}`;
                }

                const packageDisplay = [...new Set(product.packageNumbers)].join(', ');
                
                summaryData.push([
                    product.code,
                    product.name,
                    product.option,
                    packageDisplay,
                    product.ordered,
                    product.received,
                    diffText,
                    product.shippingCost,
                    status
                ]);
            });

            return summaryData;
        }

        // Utility Functions
        function showNotification(message, type = 'info') {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md transition-all duration-300 transform translate-x-full`;
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏° type
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            notification.className += ` ${colors[type] || colors.info}`;
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î icon ‡∏ï‡∏≤‡∏° type
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <div class="flex items-start space-x-3">
                    <i class="${icons[type] || icons.info} text-lg mt-0.5"></i>
                    <div class="flex-1">
                        <p class="font-medium whitespace-pre-line">${message}</p>
                    </div>
                    <button class="text-white hover:text-gray-200 transition-colors ml-2" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // ‡πÅ‡∏™‡∏î‡∏á notification
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // ‡∏ã‡πà‡∏≠‡∏ô notification ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, type === 'error' ? 8000 : 5000);
            
            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
        }





        // Missing Products Analysis Functions
        function analyzeMissingProducts() {
            console.log('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î...');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (sheetsData.length === 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', 'error');
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const selectedRound = elements.summaryRoundSelect.value;
            if (!selectedRound || !allRoundsData[selectedRound]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', 'error');
                return;
            }

            elements.analyzeMissingBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
            elements.analyzeMissingBtn.disabled = true;

            try {
                console.log('üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', sheetsData.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                console.log('üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:', selectedRound);

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° code + option (1 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠ 1 ‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥)
                const databaseProducts = {};
                sheetsData.forEach((product, index) => {
                    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    let cleanCode = (product.code || '').trim();
                    let cleanOption = (product.option || '').trim();
                    
                    // ‡∏•‡∏ö "‚îî‚îÄ " ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                    if (cleanOption.startsWith('‚îî‚îÄ ')) {
                        cleanOption = cleanOption.substring(3).trim();
                    }
                    
                    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ä‡πà‡∏ô "‡∏û‡∏µ‡∏ä (‡∏ä‡∏°‡∏û‡∏π)" -> "‡∏û‡∏µ‡∏ä"
                    if (cleanOption.includes('(') && cleanOption.includes(')')) {
                        cleanOption = cleanOption.split(' (')[0].trim();
                    }
                    
                    const key = `${cleanCode}|${cleanOption}`;
                    if (!databaseProducts[key]) {
                        databaseProducts[key] = {
                            code: cleanCode,
                            name: product.name || '',
                            option: cleanOption,
                            totalQuantity: 0
                        };
                    }
                    databaseProducts[key].totalQuantity += product.quantity || 0;
                    
                    // Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                    if (index < 5) {
                        console.log(`üìã ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${index + 1}: "${product.code}" -> "${cleanCode}" | "${product.option}" -> "${cleanOption}" = ${product.quantity} ‡∏ä‡∏¥‡πâ‡∏ô`);
                    }
                });

                console.log(`üìä ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${Object.keys(databaseProducts).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î)`);

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                const receivedProducts = {};
                const roundData = allRoundsData[selectedRound];
                const packages = roundData.packages || [];

                console.log(`üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ô‡∏£‡∏≠‡∏ö ${selectedRound}: ${packages.length} ‡∏û‡∏±‡∏™‡∏î‡∏∏`);

                packages.forEach((pkg, pkgIndex) => {
                    pkg.products.forEach((product, productIndex) => {
                        // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        let cleanCode = (product.code || '').trim();
                        let cleanOption = (product.option || '').trim();
                        
                        // ‡∏•‡∏ö "‚îî‚îÄ " ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                        if (cleanOption.startsWith('‚îî‚îÄ ')) {
                            cleanOption = cleanOption.substring(3).trim();
                        }
                        
                        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ä‡πà‡∏ô "‡∏û‡∏µ‡∏ä (‡∏ä‡∏°‡∏û‡∏π)" -> "‡∏û‡∏µ‡∏ä"
                        if (cleanOption.includes('(') && cleanOption.includes(')')) {
                            cleanOption = cleanOption.split(' (')[0].trim();
                        }
                        
                        const key = `${cleanCode}|${cleanOption}`;
                        if (!receivedProducts[key]) {
                            receivedProducts[key] = {
                                code: cleanCode,
                                name: product.name || '',
                                option: cleanOption,
                                totalReceived: 0,
                                packages: []
                            };
                        }
                        
                        const receivedQty = product.received || 0;
                        receivedProducts[key].totalReceived += receivedQty;
                        receivedProducts[key].packages.push({
                            packageNumber: pkg.packageNumber,
                            received: receivedQty
                        });
                    });
                });

                console.log(`üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${Object.keys(receivedProducts).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î)`);

                // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î - ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥ (1 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠ 1 ‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥)
                missingProductsData = [];
                let totalMissingItems = 0;
                let totalAnalyzedItems = 0;

                console.log('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

                Object.keys(databaseProducts).forEach(key => {
                    const dbProduct = databaseProducts[key];
                    const receivedProduct = receivedProducts[key];
                    const received = receivedProduct ? receivedProduct.totalReceived : 0;
                    const missing = Math.max(0, dbProduct.totalQuantity - received);
                    
                    totalAnalyzedItems++;
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥)
                    missingProductsData.push({
                        code: dbProduct.code,
                        name: dbProduct.name,
                        option: dbProduct.option,
                        inDatabase: dbProduct.totalQuantity,
                        received: received,
                        missing: missing,
                        packages: receivedProduct ? receivedProduct.packages : []
                    });
                    
                    if (missing > 0) {
                        totalMissingItems += missing;
                    }
                });

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                missingProductsData.sort((a, b) => b.missing - a.missing);

                console.log(`üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:`);
                console.log(`  - ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalAnalyzedItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                console.log(`  - ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î: ${missingProductsData.filter(p => p.missing > 0).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                console.log(`  - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏£‡∏ß‡∏°: ${totalMissingItems} ‡∏ä‡∏¥‡πâ‡∏ô`);

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                displayMissingProductsResults();

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: ' + error.message, 'error');
            } finally {
                elements.analyzeMissingBtn.innerHTML = '<i class="fas fa-calculator mr-1"></i>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î';
                elements.analyzeMissingBtn.disabled = false;
            }
        }

        function displayMissingProductsResults() {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            elements.analysisInstructions.classList.add('hidden');

            if (missingProductsData.length === 0) {
                // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢
                elements.missingProductsAlert.classList.add('hidden');
                elements.missingProductsTable.classList.add('hidden');
                elements.noMissingProductsMessage.classList.remove('hidden');
                elements.copyMissingBtn.classList.add('hidden');
                return;
            }

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const productGroups = {};
            
            missingProductsData.forEach(product => {
                if (!productGroups[product.code]) {
                    productGroups[product.code] = {
                        code: product.code,
                        name: product.name,
                        flavors: [],
                        totalInDatabase: 0,
                        totalReceived: 0,
                        totalMissing: 0
                    };
                }
                
                productGroups[product.code].flavors.push({
                    option: product.option,
                    inDatabase: product.inDatabase,
                    received: product.received,
                    missing: product.missing,
                    packages: product.packages
                });
                
                productGroups[product.code].totalInDatabase += product.inDatabase;
                productGroups[product.code].totalReceived += product.received;
                productGroups[product.code].totalMissing += product.missing;
            });

            // ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            let completeProductCodes = 0;    // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            let partialProductCodes = 0;     // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô
            let missingProductCodes = 0;     // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
            
            Object.values(productGroups).forEach(group => {
                if (group.totalMissing === 0 && group.totalReceived > 0) {
                    // ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    completeProductCodes++;
                } else if (group.totalReceived > 0 && group.totalMissing > 0) {
                    // ‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î)
                    partialProductCodes++;
                } else if (group.totalMissing > 0) {
                    // ‡∏Ç‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å)
                    missingProductCodes++;
                }
            });
            
            const totalProductCodes = Object.keys(productGroups).length;
            const receivedItems = missingProductsData.reduce((sum, item) => sum + item.received, 0);
            const totalInDatabase = missingProductsData.reduce((sum, item) => sum + item.inDatabase, 0);
            
            // ‡πÅ‡∏™‡∏î‡∏á alert ‡∏™‡∏£‡∏∏‡∏õ
            elements.noMissingProductsMessage.classList.add('hidden');
            elements.missingProductsAlert.classList.remove('hidden');
            elements.copyMissingBtn.classList.remove('hidden');
            
            elements.missingProductsSummary.innerHTML = `
                ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${totalProductCodes}</strong> ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | 
                ‡∏Ñ‡∏£‡∏ö <strong class="text-green-600">${completeProductCodes}</strong> | 
                ‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô <strong class="text-yellow-600">${partialProductCodes}</strong> | 
                ‡∏Ç‡∏≤‡∏î <strong class="text-red-600">${missingProductCodes}</strong><br>
                <small class="text-gray-600">‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ${receivedItems.toLocaleString()}/${totalInDatabase.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô (${((receivedItems/totalInDatabase)*100).toFixed(1)}%)</small>
            `;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            elements.missingProductsTable.classList.remove('hidden');
            populateMissingProductsTable();
            
            if (missingProductCodes > 0) {
                showNotification(`üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à: ‡∏Ç‡∏≤‡∏î ${missingProductCodes} ‡∏£‡∏´‡∏±‡∏™, ‡∏Ñ‡∏£‡∏ö ${completeProductCodes} ‡∏£‡∏´‡∏±‡∏™, ‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô ${partialProductCodes} ‡∏£‡∏´‡∏±‡∏™`, 'warning');
            } else {
                showNotification('üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        function showMissingDetails() {
            if (missingProductsData.length === 0) return;

            // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            const isHidden = elements.missingProductsTable.classList.contains('hidden');
            
            if (isHidden) {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                elements.missingProductsTable.classList.remove('hidden');
                elements.showMissingDetailsBtn.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                populateMissingProductsTable();
            } else {
                // ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                elements.missingProductsTable.classList.add('hidden');
                elements.showMissingDetailsBtn.innerHTML = '<i class="fas fa-list mr-1"></i>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
            }
        }

        function populateMissingProductsTable() {
            const missingProductsCards = document.getElementById('missingProductsCards');
            missingProductsCards.innerHTML = '';

            // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            filterMissingProducts();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        function filterMissingProducts() {
            const missingProductsCards = document.getElementById('missingProductsCards');
            const missingProductsCount = document.getElementById('missingProductsCount');
            const filterValue = document.getElementById('missingProductsFilter').value;
            
            if (!missingProductsCards || !missingProductsCount) return;
            
            missingProductsCards.innerHTML = '';

            if (missingProductsData.length === 0) {
                missingProductsCards.innerHTML = `
                    <div class="col-span-full py-8 px-4 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-2 block"></i>
                        <p class="text-lg font-medium">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
                        <p class="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î" ‡∏Å‡πà‡∏≠‡∏ô</p>
                    </div>
                `;
                missingProductsCount.textContent = '0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                return;
            }

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (1 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠ 1 ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
            const productGroups = {};
            
            missingProductsData.forEach(product => {
                if (!productGroups[product.code]) {
                    productGroups[product.code] = {
                        code: product.code,
                        name: product.name,
                        flavors: [],
                        totalInDatabase: 0,
                        totalReceived: 0,
                        totalMissing: 0
                    };
                }
                
                productGroups[product.code].flavors.push({
                    option: product.option,
                    inDatabase: product.inDatabase,
                    received: product.received,
                    missing: product.missing,
                    packages: product.packages
                });
                
                productGroups[product.code].totalInDatabase += product.inDatabase;
                productGroups[product.code].totalReceived += product.received;
                productGroups[product.code].totalMissing += product.missing;
            });

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            let filteredGroups = [];
            
            Object.values(productGroups).forEach(group => {
                let shouldInclude = false;
                
                switch (filterValue) {
                    case 'missing':
                        shouldInclude = group.totalMissing > 0;
                        break;
                    case 'complete':
                        shouldInclude = group.totalMissing === 0 && group.totalReceived > 0;
                        break;
                    case 'partial':
                        shouldInclude = group.totalMissing > 0 && group.totalReceived > 0;
                        break;
                    default: // 'all'
                        shouldInclude = true;
                        break;
                }
                
                if (shouldInclude) {
                    filteredGroups.push(group);
                }
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            missingProductsCount.textContent = `${filteredGroups.length} ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤`;

            if (filteredGroups.length === 0) {
                const filterText = {
                    'missing': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î',
                    'complete': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö',
                    'partial': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô',
                    'all': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
                };
                
                missingProductsCards.innerHTML = `
                    <div class="col-span-full py-8 px-4 text-center text-gray-500">
                        <i class="fas fa-filter text-4xl mb-2 block"></i>
                        <p class="text-lg font-medium">${filterText[filterValue]}</p>
                        <p class="text-sm">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô</p>
                    </div>
                `;
                return;
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            filteredGroups.sort((a, b) => a.code.localeCompare(b.code));

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (1 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠ 1 ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
            filteredGroups.forEach((group) => {
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°
                let cardClass, statusClass, statusText;
                
                if (group.totalMissing === 0 && group.totalReceived > 0) {
                    // ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥ = ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    cardClass = 'bg-green-50 border-green-200';
                    statusClass = 'bg-green-500 text-white';
                    statusText = '‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏™';
                } else if (group.totalReceived > 0 && group.totalMissing > 0) {
                    // ‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥ = ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                    cardClass = 'bg-yellow-50 border-yellow-200';
                    statusClass = 'bg-yellow-500 text-white';
                    statusText = '‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏£‡∏™';
                } else {
                    // ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏Å‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥ = ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                    cardClass = 'bg-red-50 border-red-200';
                    statusClass = 'bg-red-500 text-white';
                    statusText = '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏Å‡∏£‡∏™';
                }
                
                const card = document.createElement('div');
                card.className = `border rounded-xl p-4 transition-all duration-200 hover:shadow-md ${cardClass}`;
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö text ‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á
                const flavorsList = group.flavors.map(flavor => {
                    let statusText, statusClass;
                    
                    if (flavor.missing === 0 && flavor.received > 0) {
                        statusText = '‡∏Ñ‡∏£‡∏ö';
                        statusClass = 'bg-green-100 text-green-700 border-green-300';
                    } else if (flavor.received > 0 && flavor.missing > 0) {
                        statusText = `‡∏Ç‡∏≤‡∏î ${flavor.missing}`;
                        statusClass = 'bg-yellow-100 text-yellow-700 border-yellow-300';
                    } else {
                        statusText = `‡∏Ç‡∏≤‡∏î ${flavor.missing}`;
                        statusClass = 'bg-red-100 text-red-700 border-red-300';
                    }
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á
                    if (flavor.received > flavor.inDatabase) {
                        const excess = flavor.received - flavor.inDatabase;
                        statusText = `‡πÄ‡∏Å‡∏¥‡∏ô ${excess}`;
                        statusClass = 'bg-blue-100 text-blue-700 border-blue-300';
                    }
                    
                    return `
                        <span class="inline-block border rounded-md px-2 py-1 text-xs font-medium ${statusClass} mr-1 mb-1">
                            ${flavor.option || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ${statusText}
                        </span>
                    `;
                }).join('');
                
                card.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4 flex-1">
                                <div class="flex-shrink-0">
                                    <h5 class="font-bold text-gray-900 text-lg">${group.code}</h5>
                                    <p class="text-sm text-gray-700 font-medium">${group.name}</p>
                                </div>
                            </div>
                            <div class="flex-shrink-0 ml-4">
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">
                                    ${statusText}
                                </span>
                                <p class="text-xs text-gray-600 mt-1 text-center">
                                    <i class="fas fa-palette mr-1"></i>${group.flavors.length} ‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥
                                </p>
                            </div>
                        </div>
                        <div class="border-t pt-3">
                            <div class="flex flex-wrap">
                                ${flavorsList}
                            </div>
                        </div>
                    </div>
                `;
                
                missingProductsCards.appendChild(card);
            });
        }

        function copyMissingProducts() {
            if (missingProductsData.length === 0) {
                showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 'error');
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            let tableData = [];
            
            // Header
            tableData.push([
                '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 
                '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
                '‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                '‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß',
                '‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î'
            ]);

            // Data rows
            missingProductsData.forEach((product) => {
                tableData.push([
                    product.code,
                    product.name,
                    product.option || '-',
                    product.inDatabase.toString(),
                    product.received.toString(),
                    product.missing.toString()
                ]);
            });

            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô TSV (Tab-separated values) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Sheets
            const tsvContent = tableData.map(row => row.join('\t')).join('\n');
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
            const selectedRound = elements.summaryRoundSelect.value;
            const totalMissingItems = missingProductsData.reduce((sum, item) => sum + item.missing, 0);
            const totalInDatabase = missingProductsData.reduce((sum, item) => sum + item.inDatabase, 0);
            const totalReceived = missingProductsData.reduce((sum, item) => sum + item.received, 0);

            const summaryData = [
                '',
                `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î - ‡∏£‡∏≠‡∏ö: ${selectedRound}`,
                `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}`,
                '',
                '‡∏™‡∏£‡∏∏‡∏õ:',
                `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î: ${missingProductsData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${totalInDatabase.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô`,
                `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß: ${totalReceived.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô`,
                `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î: ${totalMissingItems.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô`,
                `‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: ${((totalReceived / totalInDatabase) * 100).toFixed(1)}%`
            ];

            const finalContent = tsvContent + '\n\n' + summaryData.join('\n');

            // Copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(finalContent).then(() => {
                    showNotification('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Google Sheets ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'success');
                }).catch(() => {
                    fallbackCopyTextToClipboard(finalContent);
                });
            } else {
                fallbackCopyTextToClipboard(finalContent);
            }
        }

        // Global functions for onclick handlers
        window.selectRound = selectRound;
        window.deleteRound = deleteRound;
        window.editProduct = function(roundName, code, option, packageNumbers) {
            console.log('üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:', { roundName, code, option, packageNumbers });
            
            if (!roundName || !allRoundsData[roundName]) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }
            
            // ‡∏´‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ
            const roundData = allRoundsData[roundName];
            const packagesWithProduct = [];
            
            roundData.packages.forEach(pkg => {
                pkg.products.forEach((product, productIndex) => {
                    if (product.code === code && product.option === option) {
                        packagesWithProduct.push({
                            packageNumber: pkg.packageNumber,
                            productIndex: productIndex,
                            product: product,
                            packageIndex: roundData.packages.indexOf(pkg)
                        });
                    }
                });
            });
            
            if (packagesWithProduct.length === 0) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                return;
            }
            
            console.log('üì¶ ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô', packagesWithProduct.length, '‡∏û‡∏±‡∏™‡∏î‡∏∏');
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö inline
            const editForm = document.createElement('div');
            editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            editForm.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-96 overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${code}</h2>
                        <button id="closeEditForm" class="text-gray-500 hover:text-gray-700 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <strong>${option}</strong></p>
                        <p class="text-sm text-gray-600">‡∏û‡∏ö‡πÉ‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏: <strong>${packagesWithProduct.map(p => p.packageNumber).join(', ')}</strong></p>
                    </div>
                    
                    <div class="space-y-4" id="editProductList">
                        ${packagesWithProduct.map((item, index) => `
                            <div class="border border-gray-200 rounded-lg p-4" id="editItem_${index}">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-medium text-gray-900">‡∏û‡∏±‡∏™‡∏î‡∏∏: ${item.packageNumber}</h4>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm text-gray-500">‡∏™‡∏±‡πà‡∏á: ${item.product.ordered || 0} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                                        <button type="button" class="delete-edit-item text-red-500 hover:text-red-700 transition-colors" data-index="${index}" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</label>
                                        <input type="number" id="received_${index}" value="${item.product.received || 0}" min="0" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                                        <input type="number" id="shipping_${index}" value="${item.product.shippingCost || 0}" min="0" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button id="cancelEdit" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button id="saveEdit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-save mr-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editForm);
            
            // Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            document.getElementById('closeEditForm').addEventListener('click', () => {
                document.body.removeChild(editForm);
            });
            
            document.getElementById('cancelEdit').addEventListener('click', () => {
                document.body.removeChild(editForm);
            });
            
            // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ popup)
            editForm.addEventListener('click', (e) => {
                if (e.target.closest('.delete-edit-item')) {
                    const button = e.target.closest('.delete-edit-item');
                    const index = parseInt(button.getAttribute('data-index'));
                    const item = packagesWithProduct[index];
                    
                    // ‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á confirm
                    console.log(`üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${code} - ${option} ‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏ ${item.packageNumber}`);
                    
                    // ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏
                    allRoundsData[roundName].packages[item.packageIndex].products.splice(item.productIndex, 1);
                    
                    // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                    const editItem = document.getElementById(`editItem_${index}`);
                    if (editItem) {
                        editItem.style.display = 'none';
                        editItem.setAttribute('data-deleted', 'true');
                    }
                    
                    showNotification(`‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏ "${item.packageNumber}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    const remainingItems = packagesWithProduct.filter((_, i) => {
                        const element = document.getElementById(`editItem_${i}`);
                        return !element || element.getAttribute('data-deleted') !== 'true';
                    });
                    
                    if (remainingItems.length === 0) {
                        showNotification('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°...', 'info');
                        setTimeout(() => {
                            saveData();
                            updateSummaryTable();
                            document.body.removeChild(editForm);
                        }, 1500);
                    }
                }
            });

            document.getElementById('saveEdit').addEventListener('click', () => {
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                let hasChanges = false;
                let deletedCount = 0;
                
                packagesWithProduct.forEach((item, index) => {
                    const editItem = document.getElementById(`editItem_${index}`);
                    
                    // ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
                    if (editItem && editItem.getAttribute('data-deleted') === 'true') {
                        deletedCount++;
                        hasChanges = true;
                        return;
                    }
                    
                    const receivedInput = document.getElementById(`received_${index}`);
                    const shippingInput = document.getElementById(`shipping_${index}`);
                    
                    if (!receivedInput || !shippingInput) return;
                    
                    const newReceived = parseInt(receivedInput.value) || 0;
                    const newShippingCost = parseInt(shippingInput.value) || 0;
                    
                    const oldReceived = item.product.received || 0;
                    const oldShippingCost = item.product.shippingCost || 0;
                    
                    if (newReceived !== oldReceived || newShippingCost !== oldShippingCost) {
                        hasChanges = true;
                        
                        // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô)
                        const pkg = allRoundsData[roundName].packages[item.packageIndex];
                        const productIndex = pkg.products.findIndex(p => 
                            p.code === item.product.code && 
                            p.option === item.product.option &&
                            p.received === item.product.received &&
                            p.shippingCost === item.product.shippingCost
                        );
                        
                        if (productIndex !== -1) {
                            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            pkg.products[productIndex].received = newReceived;
                            pkg.products[productIndex].shippingCost = newShippingCost;
                            
                            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
                            const ordered = item.product.ordered || 0;
                            const missing = Math.max(0, ordered - newReceived);
                            const excess = Math.max(0, newReceived - ordered);
                            
                            pkg.products[productIndex].missing = missing;
                            pkg.products[productIndex].excess = excess;
                            
                            console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏±‡∏™‡∏î‡∏∏ ${item.packageNumber}: ‡πÑ‡∏î‡πâ ${oldReceived} -> ${newReceived}, ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${oldShippingCost} -> ${newShippingCost}`);
                        }
                    }
                });
                
                if (hasChanges) {
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    saveData();
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                    updateSummaryTable();
                    
                    let message = `‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${code} - ${option}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`;
                    if (deletedCount > 0) {
                        message += `\nüóëÔ∏è ‡∏•‡∏ö ${deletedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    }
                    
                    showNotification(message, 'success');
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'info');
                }
                
                document.body.removeChild(editForm);
            });
            
            // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            editForm.addEventListener('click', (e) => {
                if (e.target === editForm) {
                    document.body.removeChild(editForm);
                }
            });
        };

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9765de2902ab7329',t:'MTc1NjQwNTcwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
